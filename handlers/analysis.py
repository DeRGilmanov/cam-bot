import logging
import re
from typing import List, Dict, Optional, Tuple
from datetime import datetime, timedelta
from telegram import Update
from telegram.ext import ContextTypes
from config import config
from database import DatabaseManager
from ai_client import AIClient  # –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞

logger = logging.getLogger(__name__)

class AnalysisHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ –∞–Ω–∞–ª–∏–∑–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤"""
    
    def __init__(self, db: DatabaseManager):
        self.db = db
        self.ai_client = AIClient()  # –ó–∞–º–µ–Ω—è–µ–º OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π
    
    async def handle_opinion(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /opinion - —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º"""
        try:
            chat_id = update.effective_chat.id
            message = update.effective_message
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
            if not context.args:
                await message.reply_text(
                    "üë§ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /opinion:**\n\n"
                    "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n"
                    "`/opinion @username`\n"
                    "`/opinion –ò–º—è`\n"
                    "`/opinion @username 50` (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π)\n\n"
                    "üí° *–ê–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*"
                )
                return
            
            # –ü–∞—Ä—Å–∏–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã
            username, message_limit = self._parse_opinion_arguments(context.args)
            
            if not username:
                await message.reply_text("‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
                return
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_messages = self.db.get_user_messages(chat_id, username, message_limit)
            
            if not user_messages:
                await message.reply_text(
                    f"üì≠ –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '{username}'.\n"
                    f"–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:\n"
                    f"‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—Å–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —ç—Ç–æ–º —á–∞—Ç–µ\n"
                    f"‚Ä¢ –ò–º—è —É–∫–∞–∑–∞–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ\n"
                    f"‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª–µ–Ω—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏"
                )
                return
            
            # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            processing_msg = await message.reply_text(
                f"üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è {username}..."
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –ª–∏—á–Ω–æ—Å—Ç—å –±–æ—Ç–∞
            personality = self._get_bot_personality(chat_id)
            
            # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            analysis = await self._analyze_user_behavior(username, user_messages, personality)
            
            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            await processing_msg.delete()
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            response_text = self._format_opinion_response(username, analysis, len(user_messages))
            await message.reply_text(response_text, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in handle_opinion: {e}")
            await self._send_error_message(update, "–ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    
    async def handle_comment(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /comment - –∞–Ω–∞–ª–∏–∑ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ"""
        try:
            chat_id = update.effective_chat.id
            message = update.effective_message
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã
            messages = self.db.get_recent_messages(chat_id, config.COMMENT_MESSAGE_LIMIT)
            
            if not messages:
                await message.reply_text(
                    "üí¨ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã.\n"
                    "–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∫–∞ –≤ —á–∞—Ç–µ –ø–æ—è–≤–∏—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ."
                )
                return
            
            # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            processing_msg = await message.reply_text(
                "üí≠ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–∫—É—â–µ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ..."
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –ª–∏—á–Ω–æ—Å—Ç—å –±–æ—Ç–∞
            personality = self._get_bot_personality(chat_id)
            
            # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ
            comment = await self._create_topic_comment(messages, personality)
            
            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            await processing_msg.delete()
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            response_text = self._format_comment_response(comment)
            await message.reply_text(response_text, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in handle_comment: {e}")
            await self._send_error_message(update, "–ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–µ–∫—É—â–µ–π —Ç–µ–º—ã")
    
    async def _analyze_user_behavior(self, username: str, messages: List[Dict], personality: str = "") -> str:
        """–ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–æ–º–æ—â—å—é Yandex GPT"""
        messages_text = self._format_user_messages_for_analysis(messages)
        
        system_message = self._build_system_message(
            base_role=(
                "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö. "
                "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π. "
                "–ë—É–¥—å –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–º, —Ç–∞–∫—Ç–∏—á–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º. "
                "–ù–µ –¥–µ–ª–∞–π –ø–æ—Å–ø–µ—à–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤ –∏ –Ω–µ –æ—Ü–µ–Ω–∏–≤–∞–π –ª–∏—á–Ω–æ—Å—Ç—å –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ. "
                "–§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –Ω–∞–±–ª—é–¥–∞–µ–º—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏."
            ),
            personality=personality
        )
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ.

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:** {username}
**–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π:** {len(messages)}

**–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
{messages_text}

**–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –∞—Å–ø–µ–∫—Ç—ã:**

üéØ **–°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:**
- –§–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç—å/–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç—å
- –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–∫—Ä–∞—Å–∫–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏, —Å—Ç–∏–∫–µ—Ä–æ–≤
- –î–ª–∏–Ω–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

üí≠ **–¢–µ–º—ã –∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã:**
- –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- –°—Ñ–µ—Ä–∞ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
- –¢–∏–ø—ã –≤–æ–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞–µ—Ç

ü§ù **–ö–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏:**
- –°–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –¥–∏–∞–ª–æ–≥—É –∏–ª–∏ –º–æ–Ω–æ–ª–æ–≥—É
- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –æ–±—Å—É–∂–¥–µ–Ω–∏—è—Ö
- –°—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
- –£—á–∞—Å—Ç–∏–µ –≤ —Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º

üìä **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–ª–æ–≤–∞/—Ñ—Ä–∞–∑—ã
- –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å—Ç–∏–ª—è
- –†–æ–ª—å –≤ –≥—Ä—É–ø–ø–µ (–ª–∏–¥–µ—Ä, —ç–∫—Å–ø–µ—Ä—Ç, —É—á–∞—Å—Ç–Ω–∏–∫ –∏ —Ç.–¥.)

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∞–Ω–∞–ª–∏–∑—É:**
- –ë—É–¥—å –æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–º –∏ –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º –Ω–∞ —Ñ–∞–∫—Ç–∞—Ö
- –ò–∑–±–µ–≥–∞–π –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã—Ö –æ—Ü–µ–Ω–æ–∫ –ª–∏—á–Ω–æ—Å—Ç–∏
- –ü–æ–¥–∫—Ä–µ–ø–ª—è–π –≤—ã–≤–æ–¥—ã –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
- –ë—É–¥—å —Ç–∞–∫—Ç–∏—á–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º
- –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

**–ê–Ω–∞–ª–∏–∑:**"""
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è AI
        ai_messages = [
            {"role": "system", "content": system_message},
            {"role": "user", "content": prompt}
        ]
        
        analysis = await self.ai_client.chat_completion(
            ai_messages,
            max_tokens=config.ANALYSIS_MAX_TOKENS,
            temperature=0.5
        )
        
        if not analysis:
            return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
        
        return self._validate_analysis_tone(analysis)
    
    async def _create_topic_comment(self, messages: List[Dict], personality: str = "") -> str:
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∫ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é Yandex GPT"""
        conversation_text = self._format_messages_for_topic_analysis(messages)
        
        system_message = self._build_system_message(
            base_role=(
                "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –≥—Ä—É–ø–ø–æ–≤—ã—Ö –¥–∏—Å–∫—É—Å—Å–∏–π. "
                "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –≤ —á–∞—Ç–µ –∏ –¥–∞–≤–∞—Ç—å "
                "–ø–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, insights –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é —Ç–µ–º—ã. "
                "–ë—É–¥—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–º, –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤."
            ),
            personality=personality
        )
        
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—É—â–µ–µ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –≤ —á–∞—Ç–µ –∏ —Å–æ–∑–¥–∞–π insightful –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:

**–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
{conversation_text}

**–°–æ–∑–¥–∞–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–π –≤–∫–ª—é—á–∞–µ—Ç:**

üéØ **–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è:**
- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ –∏ –ø–æ–¥—Ç–µ–º—ã
- –£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –°—Ç–∞–¥–∏—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è (–Ω–∞—á–∞–ª–æ, –∞–∫—Ç–∏–≤–Ω–∞—è —Ñ–∞–∑–∞, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ)

üí° **Key Insights:**
- –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è
- –í–æ–∑–Ω–∏–∫–∞—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
- –ù–µ–≤—ã—Å–∫–∞–∑–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è

üöÄ **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è:**
- –í–æ–ø—Ä–æ—Å—ã –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–∏—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è
- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
- –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –æ–±—Å—É–∂–¥–∞–µ–º—ã—Ö –ø—Ä–æ–±–ª–µ–º

‚ö° **–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:**
- –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ç–µ–∫—É—â–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏
- –ü–æ–ª–µ–∑–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
- –¢–∞–∫—Ç–∏—á–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ë—É–¥—å –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º
- –ò–∑–±–µ–≥–∞–π –±–∞–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- –ü—Ä–µ–¥–ª–∞–≥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–¥–µ–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è —Ç–µ–º—ã
- –ë—É–¥—å —Ç–∞–∫—Ç–∏—á–Ω—ã–º –∏ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–º –∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–π –∂–∏–≤–æ–π, –≤–æ–≤–ª–µ–∫–∞—é—â–∏–π —Å—Ç–∏–ª—å
- –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

**–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:**"""
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è AI
        ai_messages = [
            {"role": "system", "content": system_message},
            {"role": "user", "content": prompt}
        ]
        
        comment = await self.ai_client.chat_completion(
            ai_messages,
            max_tokens=800,
            temperature=0.7
        )
        
        if not comment:
            return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ."
        
        return comment
    
    def _parse_opinion_arguments(self, args: List[str]) -> Tuple[Optional[str], int]:
        """–ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥—ã /opinion"""
        if not args:
            return None, config.OPINION_DEFAULT_MESSAGES
        
        username = args[0].replace('@', '')  # –£–±–∏—Ä–∞–µ–º @ –µ—Å–ª–∏ –µ—Å—Ç—å
        
        # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
        message_limit = config.OPINION_DEFAULT_MESSAGES
        if len(args) > 1:
            try:
                message_limit = int(args[1])
                message_limit = max(
                    config.OPINION_MIN_MESSAGES, 
                    min(message_limit, config.OPINION_MAX_MESSAGES)
                )
            except (ValueError, TypeError):
                pass
        
        return username, message_limit
    
    def _format_user_messages_for_analysis(self, messages: List[Dict]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"""
        formatted = []
        for i, msg in enumerate(messages, 1):
            text = msg.get('text', '')
            timestamp = msg.get('timestamp', '')
            
            if text and len(text.strip()) > 0:
                # –û–±—Ä–µ–∑–∞–µ–º –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if len(text) > 150:
                    text = text[:147] + "..."
                formatted.append(f"{i}. [{timestamp}] {text}")
        
        return "\n".join(formatted[:50])  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 50 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    
    def _format_messages_for_topic_analysis(self, messages: List[Dict]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–º—ã"""
        formatted = []
        for msg in messages:
            user = msg.get('user', 'Unknown')
            text = msg.get('text', '')
            
            if text and len(text.strip()) > 0:
                # –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if len(text) > 100:
                    text = text[:97] + "..."
                formatted.append(f"{user}: {text}")
        
        return "\n".join(formatted)
    
    def _validate_analysis_tone(self, analysis: str) -> str:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–Ω–∞ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç —Ç–∞–∫—Ç–∏—á–Ω–æ—Å—Ç–∏"""
        # –°–ø–∏—Å–æ–∫ —Ñ—Ä–∞–∑, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –≤–æ—Å–ø—Ä–∏–Ω—è—Ç—ã –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ
        negative_phrases = [
            "–ø–ª–æ—Ö–æ–π", "–Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π", "—Å–ª–∞–±—ã–π", "–Ω–µ—É–¥–∞—á–Ω—ã–π", 
            "–ø—Ä–æ–±–ª–µ–º–∞ —Å", "–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫", "–º–∏–Ω—É—Å", "–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π"
        ]
        
        analysis_lower = analysis.lower()
        if any(phrase in analysis_lower for phrase in negative_phrases):
            # –î–æ–±–∞–≤–ª—è–µ–º –¥–∏—Å–∫–ª–µ–π–º–µ—Ä –æ —Ç–∞–∫—Ç–∏—á–Ω–æ—Å—Ç–∏
            disclaimer = "\n\n---\n*–ê–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ —Å—Ç–∏–ª–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ü–µ–Ω–∫–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏.*"
            return analysis + disclaimer
        
        return analysis
    
    def _format_opinion_response(self, username: str, analysis: str, message_count: int) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è /opinion"""
        return f"""üë§ **–ê–Ω–∞–ª–∏–∑ —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è:** @{username}

**üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π:** {message_count}

**üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞:**
{analysis}

---
*–ê–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Å—Ç–∏–ª—å –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏, –∞ –Ω–µ –ª–∏—á–Ω–æ—Å—Ç–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏.*"""
    
    def _format_comment_response(self, comment: str) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è /comment"""
        return f"""üí¨ **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ç–µ–∫—É—â–µ–º—É –æ–±—Å—É–∂–¥–µ–Ω–∏—é:**

{comment}

---
*–ê–Ω–∞–ª–∏–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —á–∞—Ç–∞.*"""
    
    def _get_bot_personality(self, chat_id: int) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞ –¥–ª—è —á–∞—Ç–∞"""
        try:
            settings = self.db.get_chat_settings(chat_id)
            return settings.get('bot_personality', '')
        except Exception as e:
            logger.error(f"Error getting bot personality: {e}")
            return ""
    
    def _build_system_message(self, base_role: str, personality: str = "") -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –ª–∏—á–Ω–æ—Å—Ç–∏"""
        if personality:
            return f"{base_role}\n\n–¢–≤–æ—è –ª–∏—á–Ω–æ—Å—Ç—å: {personality}"
        return base_role
    
    async def _send_error_message(self, update: Update, action: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"""
        try:
            await update.effective_message.reply_text(
                f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ {action}. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
            )
        except Exception as e:
            logger.error(f"Error sending error message: {e}")