import logging
import re
import aiohttp
import json
from typing import List, Dict, Optional
from telegram import Update
from telegram.ext import ContextTypes
from config import config
from database import DatabaseManager
from ai_client import AIClient  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç

logger = logging.getLogger(__name__)

class QuestionsHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –æ—Ç–≤–µ—Ç–∞–º–∏"""
    
    def __init__(self, db: DatabaseManager):
        self.db = db
        self.ai_client = AIClient()  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π AI –∫–ª–∏–µ–Ω—Ç
    
    async def handle_ask(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /ask - –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"""
        try:
            chat_id = update.effective_chat.id
            message = update.effective_message
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–æ–ø—Ä–æ—Å
            if not context.args:
                await message.reply_text(
                    "‚ùì **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /ask:**\n\n"
                    "–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–∏ —á–∞—Ç–∞:\n"
                    "`/ask –∫–∞–∫–∏–µ —Ç–µ–º—ã –æ–±—Å—É–∂–¥–∞–ª–∏ –≤—á–µ—Ä–∞?`\n"
                    "`/ask —á—Ç–æ —Ä–µ—à–∏–ª–∏ –ø–æ –ø—Ä–æ–µ–∫—Ç—É X?`\n"
                    "`/ask –∫—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞–ª –∏–¥–µ—é Y?`"
                )
                return
            
            question = " ".join(context.args)
            
            # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            messages = self.db.get_recent_messages(chat_id, config.MAX_MESSAGES_FOR_ANALYSIS)
            
            if not messages:
                await message.reply_text(
                    "üì≠ –í –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. "
                    "–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø–æ–∫–∞ –Ω–∞–∫–æ–ø–∏—Ç—Å—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π."
                )
                return
            
            # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            processing_msg = await message.reply_text(
                "üîç –ò—â—É –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞..."
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –ª–∏—á–Ω–æ—Å—Ç—å –±–æ—Ç–∞
            personality = self._get_bot_personality(chat_id)
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å
            answer = await self._answer_question_based_on_chat(question, messages, personality)
            
            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            await processing_msg.delete()
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
            response_text = self._format_ask_response(question, answer, len(messages))
            await message.reply_text(response_text, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in handle_ask: {e}")
            await self._send_error_message(update, "–ø—Ä–∏ –ø–æ–∏—Å–∫–µ –æ—Ç–≤–µ—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞")
    
    async def handle_gpt(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /gpt - –æ—Ç–≤–µ—Ç –Ω–∞ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å —Å –ø–æ–º–æ—â—å—é Yandex GPT"""
        try:
            message = update.effective_message
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–æ–ø—Ä–æ—Å
            if not context.args:
                await message.reply_text(
                    "ü§ñ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /gpt:**\n\n"
                    "–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å:\n"
                    "`/gpt –æ–±—ä—è—Å–Ω–∏ –∫–≤–∞–Ω—Ç–æ–≤—É—é —Ñ–∏–∑–∏–∫—É`\n"
                    "`/gpt –Ω–∞–ø–∏—à–∏ –ø–ª–∞–Ω –ø—Ä–æ–µ–∫—Ç–∞`\n"
                    "`/gpt –∫–∞–∫ –Ω–∞—É—á–∏—Ç—å—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å?`\n\n"
                    f"üí° *–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç {config.get_ai_provider_info()} –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤*"
                )
                return
            
            question = " ".join(context.args)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –≤–æ–ø—Ä–æ—Å–∞
            if len(question) < 3:
                await message.reply_text("‚ùì –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ –±–æ–ª–µ–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –≤–æ–ø—Ä–æ—Å.")
                return
            
            if len(question) > config.MAX_QUESTION_LENGTH:
                await message.reply_text(f"üìè –í–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –µ–≥–æ –¥–æ {config.MAX_QUESTION_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤.")
                return
            
            # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            processing_msg = await message.reply_text(
                "ü§î –î—É–º–∞—é –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º..."
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
            answer = await self._answer_general_question(question)
            
            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
            await processing_msg.delete()
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
            response_text = self._format_gpt_response(question, answer)
            await message.reply_text(response_text, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in handle_gpt: {e}")
            await self._send_error_message(update, "–ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–ø—Ä–æ—Å–∞")
    
    async def _answer_question_based_on_chat(self, question: str, messages: List[Dict], personality: str = "") -> str:
        """–û—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"""
        conversation_text = self._format_messages_for_qa(messages)
        
        system_message = self._build_system_message(
            base_role=(
                "–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —á–∞—Ç–∞. "
                "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã. "
                "–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á–µ—Å—Ç–Ω–æ –≥–æ–≤–æ—Ä–∏ –æ–± —ç—Ç–æ–º. "
                "–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞. "
                "–ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫–æ–≥–¥–∞ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ."
            ),
            personality=personality
        )
        
        prompt = f"""–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —á–∞—Ç–∞:

{conversation_text}

–í–æ–ø—Ä–æ—Å: {question}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å. 

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:**
1. –û—Ç–≤–µ—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
2. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —É–∫–∞–∂–∏ —ç—Ç–æ —á–µ—Ç–∫–æ
3. –ï—Å–ª–∏ –º–æ–∂–Ω–æ, —É–∫–∞–∂–∏ –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏–ª –æ–± —ç—Ç–æ–º
4. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏–∏
5. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø–æ–ª–µ–∑–Ω—ã–º
6. –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π
7. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

**–û—Ç–≤–µ—Ç:**"""
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è AI
        ai_messages = [
            {"role": "system", "content": system_message},
            {"role": "user", "content": prompt}
        ]
        
        answer = await self.ai_client.chat_completion(ai_messages, max_tokens=800, temperature=0.3)
        
        if not answer:
            return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI-—Å–µ—Ä–≤–∏—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç —É–∫–ª–æ–Ω—á–∏–≤—ã–º
        if self._is_evasive_answer(answer):
            return self._handle_insufficient_information(question)
        
        return answer
    
    async def _answer_general_question(self, question: str) -> str:
        """–û—Ç–≤–µ—Ç –Ω–∞ –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å —Å –ø–æ–º–æ—â—å—é Yandex GPT —Å fallback"""
        system_message = (
            "–¢—ã - –ø–æ–ª–µ–∑–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥—Ä–æ–±–Ω–æ, —Ç–æ—á–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ. "
            "–ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏. "
            "–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏. "
            "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ–ø–æ–Ω—è—Ç–µ–Ω –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∏—è, –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å. "
            "–ë—É–¥—å –≤–µ–∂–ª–∏–≤—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º."
        )
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞
        question_type = self._classify_question(question)
        enhanced_prompt = self._enhance_prompt_based_on_type(question, question_type)
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è AI
        ai_messages = [
            {"role": "system", "content": system_message},
            {"role": "user", "content": enhanced_prompt}
        ]
        
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ AI
        answer = await self.ai_client.chat_completion(ai_messages, max_tokens=1200, temperature=0.7)
        
        # –ï—Å–ª–∏ AI –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
        if not answer:
            return self._get_fallback_response(question)
        
        return self._postprocess_answer(answer, question_type)

    def _get_fallback_response(self, question: str) -> str:
        """Fallback –æ—Ç–≤–µ—Ç –∫–æ–≥–¥–∞ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"""
        question_lower = question.lower()
        
        # –ë–∞–∑–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        if any(word in question_lower for word in ['–ø—Ä–∏–≤–µ—Ç', 'hello', 'hi', '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π']):
            return "–ü—Ä–∏–≤–µ—Ç! üëã –†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, AI-—Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ —è –º–æ–≥—É –ø–æ–º–æ—á—å —Å –±–∞–∑–æ–≤—ã–º–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏."
        
        elif any(word in question_lower for word in ['–∫–∞–∫ –¥–µ–ª–∞', 'how are you']):
            return "–í—Å—ë —Ö–æ—Ä–æ—à–æ, —Å–ø–∞—Å–∏–±–æ! üòä AI-—Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞—é—Ç."
        
        elif any(word in question_lower for word in ['–ø–æ–º–æ—â—å', 'help', '–∫–æ–º–∞–Ω–¥—ã']):
            return ("ü§ñ **–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n\n"
                    "‚Ä¢ `/summary [n]` - —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞\n"
                    "‚Ä¢ `/themes [n]` - –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã\n"
                    "‚Ä¢ `/ask [–≤–æ–ø—Ä–æ—Å]` - –ø–æ–∏—Å–∫ –≤ –∏—Å—Ç–æ—Ä–∏–∏\n"
                    "‚Ä¢ `/gpt [–≤–æ–ø—Ä–æ—Å]` - –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å\n"
                    "‚Ä¢ `/opinion [@user]` - –∞–Ω–∞–ª–∏–∑ —Å—Ç–∏–ª—è\n\n"
                    "üí° *AI-—Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω*")
        
        elif any(word in question_lower for word in ['—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å', '—Ñ—É–Ω–∫—Ü–∏–∏']):
            return ("ü§ñ **–ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**\n\n"
                    "‚Ä¢ –ê–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–æ–≤\n"
                    "‚Ä¢ –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –æ–±—Å—É–∂–¥–µ–Ω–∏–π\n"
                    "‚Ä¢ –ü–æ–∏—Å–∫ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π\n"
                    "‚Ä¢ –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã\n\n"
                    "üîß *–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç AI-—Å–µ—Ä–≤–∏—Å –Ω–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏*")
        
        # –û–±—â–∏–π fallback –æ—Ç–≤–µ—Ç
        else:
            return (f"ü§ñ **–í–∞—à –≤–æ–ø—Ä–æ—Å:** '{question}'\n\n"
                    "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, AI-—Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. üõ†Ô∏è\n\n"
                    "–ß—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å:\n"
                    "‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ–∑–∂–µ\n"
                    "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/ask` –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞\n"
                    "‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É\n\n"
                    "–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞!")

    def _classify_question(self, question: str) -> str:
        """–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞"""
        question_lower = question.lower()
        
        if any(word in question_lower for word in ['–∫–∞–∫', 'how to', '–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è', '—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ']):
            return "how_to"
        elif any(word in question_lower for word in ['—á—Ç–æ —Ç–∞–∫–æ–µ', '—á—Ç–æ –∑–Ω–∞—á–∏—Ç', '–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ', 'definition']):
            return "definition"
        elif any(word in question_lower for word in ['–ø–æ—á–µ–º—É', 'why', '–ø—Ä–∏—á–∏–Ω–∞', 'cause']):
            return "explanation"
        elif any(word in question_lower for word in ['—Å—Ä–∞–≤–Ω–∏', 'difference', '—Ä–∞–∑–Ω–∏—Ü–∞', 'vs', '–∏–ª–∏']):
            return "comparison"
        elif any(word in question_lower for word in ['—Å–ø–∏—Å–æ–∫', 'list', '–ø–µ—Ä–µ—á–µ–Ω—å', '–ø—Ä–∏–º–µ—Ä—ã']):
            return "list"
        elif re.search(r'\d+', question) and any(word in question_lower for word in ['—Å–æ–≤–µ—Ç', 'tip', 'recommend']):
            return "numbered_advice"
        else:
            return "general"
    
    def _enhance_prompt_based_on_type(self, question: str, question_type: str) -> str:
        """–£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞"""
        base_prompt = f"–í–æ–ø—Ä–æ—Å: {question}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ."
        
        enhancements = {
            "how_to": (
                f"{base_prompt}\n\n–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é. "
                "–ò—Å–ø–æ–ª—å–∑—É–π –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —à–∞–≥–æ–≤. "
                "–î–æ–±–∞–≤—å —Å–æ–≤–µ—Ç—ã –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ."
            ),
            "definition": (
                f"{base_prompt}\n\n–î–∞–π —á–µ—Ç–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ. "
                "–ü—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. "
                "–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏."
            ),
            "explanation": (
                f"{base_prompt}\n\n–û–±—ä—è—Å–Ω–∏ –ø—Ä–∏—á–∏–Ω—ã –∏ —Å–ª–µ–¥—Å—Ç–≤–∏—è. "
                "–ò—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞–ª–æ–≥–∏–∏ –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ. "
                "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ËÉåÊôØ‰ø°ÊÅØ."
            ),
            "comparison": (
                f"{base_prompt}\n\n–°—Ä–∞–≤–Ω–∏ –æ–±—ä–µ–∫—Ç—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º. "
                "–ò—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫. "
                "–£–∫–∞–∂–∏ –ø–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞."
            ),
            "list": (
                f"{base_prompt}\n\n–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫. "
                "–ì—Ä—É–ø–ø–∏—Ä—É–π —ç–ª–µ–º–µ–Ω—Ç—ã –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ. "
                "–ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏."
            ),
            "numbered_advice": (
                f"{base_prompt}\n\n–î–∞–π –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã. "
                "–ù–∞—á–∏–Ω–∞–π –∫–∞–∂–¥—ã–π —Å–æ–≤–µ—Ç —Å —Ü–∏—Ñ—Ä—ã. "
                "–ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º."
            ),
            "general": base_prompt
        }
        
        return enhancements.get(question_type, base_prompt)
    
    def _postprocess_answer(self, answer: str, question_type: str) -> str:
        """–ü–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞"""
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
        if len(answer) > 3000:
            answer = answer[:2997] + "..."
        
        # –î–æ–±–∞–≤–∏–º —ç–º–æ–¥–∑–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≤–æ–ø—Ä–æ—Å–∞
        emoji_map = {
            "how_to": "üõ†Ô∏è",
            "definition": "üìö", 
            "explanation": "üîç",
            "comparison": "‚öñÔ∏è",
            "list": "üìã",
            "numbered_advice": "üí°",
            "general": "ü§ñ"
        }
        
        emoji = emoji_map.get(question_type, "ü§ñ")
        if not answer.startswith(emoji):
            answer = f"{emoji} {answer}"
        
        return answer
    
    def _format_messages_for_qa(self, messages: List[Dict]) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤-–æ—Ç–≤–µ—Ç–æ–≤"""
        formatted = []
        for i, msg in enumerate(messages, 1):
            user = msg.get('user', 'Unknown')
            text = msg.get('text', '')
            timestamp = msg.get('timestamp', '')
            
            if text and len(text.strip()) > 0:
                # –û–±—Ä–µ–∑–∞–µ–º –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if len(text) > 200:
                    text = text[:197] + "..."
                formatted.append(f"{i}. {user} ({timestamp}): {text}")
        
        return "\n".join(formatted)
    
    def _is_evasive_answer(self, answer: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–≤–µ—Ç —É–∫–ª–æ–Ω—á–∏–≤—ã–º (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)"""
        evasive_phrases = [
            "–Ω–µ –º–æ–≥—É –Ω–∞–π—Ç–∏",
            "–Ω–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è", 
            "–Ω–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
            "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç",
            "–Ω–µ –≥–æ–≤–æ—Ä–∏—Ç—Å—è",
            "–Ω–µ –æ–±—Å—É–∂–¥–∞–ª–æ—Å—å",
            "–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –Ω–µ—Ç",
            "–Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏"
        ]
        
        answer_lower = answer.lower()
        return any(phrase in answer_lower for phrase in evasive_phrases)
    
    def _handle_insufficient_information(self, question: str) -> str:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏"""
        return (
            "ü§î –ù–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å.\n\n"
            "–í–æ–∑–º–æ–∂–Ω–æ:\n"
            "‚Ä¢ –≠—Ç–∞ —Ç–µ–º–∞ –Ω–µ –æ–±—Å—É–∂–¥–∞–ª–∞—Å—å –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö\n"
            "‚Ä¢ –í–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏\n"
            "‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å\n\n"
            "–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `/gpt` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å."
        )
    
    def _format_ask_response(self, question: str, answer: str, message_count: int) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è /ask"""
        return f"""üîç **–í–æ–ø—Ä–æ—Å:** {question}

**üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π:** {message_count}

**üí° –û—Ç–≤–µ—Ç:**
{answer}"""
    
    def _format_gpt_response(self, question: str, answer: str) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è /gpt"""
        provider_info = config.get_ai_provider_info()
        return f"""ü§ñ **–í–æ–ø—Ä–æ—Å:** {question}

**üí≠ –û—Ç–≤–µ—Ç {provider_info}:**
{answer}

---
*–û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º*"""
    
    def _get_bot_personality(self, chat_id: int) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞ –¥–ª—è —á–∞—Ç–∞"""
        # –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –ø–æ–∑–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        return ""
    
    def _build_system_message(self, base_role: str, personality: str = "") -> str:
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –ª–∏—á–Ω–æ—Å—Ç–∏"""
        if personality:
            return f"{base_role}\n\n–¢–≤–æ—è –ª–∏—á–Ω–æ—Å—Ç—å: {personality}"
        return base_role
    
    async def _send_error_message(self, update: Update, action: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ"""
        try:
            await update.effective_message.reply_text(
                f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ {action}. "
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
            )
        except Exception as e:
            logger.error(f"Error sending error message: {e}")